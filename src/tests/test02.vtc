varnishtest "Test std.hash_req_body"

server s1 {
	rxreq
	txresp
	rxreq
	txresp
	rxreq
	txresp
} -start

varnish v1 -vcl+backend {
	import transbody from "${vmod_topbuild}/src/.libs/libvmod_transbody.so";
	import ${vmod_std};

	sub vcl_recv {
		transbody.cache_req_body(110B);
		return (hash);
	}

	sub vcl_hash {
		transbody.hash_req_body();
		return (lookup);
	}

} -start
client c1 {
	txreq -req POST -nolen -hdr "Transfer-encoding: chunked"
	chunked {BLAS}
	delay .2
	chunkedlen 110
	expect_close
} -run


client c1 {
	txreq -req POST -nolen -hdr "Transfer-encoding: chunked"
	chunked {BLAS}
	delay .2
	chunkedlen 90
	delay .2
	chunked {FOO}
	delay .2
	chunkedlen 0
	rxresp
} -run




client c2 {
	txreq -req POST -url "/banane" -body "FOOBAR"
	rxresp
} -run

client c2 {
	txreq -req GET -url "/banane" -body "FOOBAR"
	rxresp
} -run

